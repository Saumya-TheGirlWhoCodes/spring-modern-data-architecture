<html>
    <head>
        <link href="/webjars/bootstrap/css/bootstrap.min.css" rel="stylesheet">
        <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
        <link rel="stylesheet" href="styles/promotions-styles.css">


        <script src="/webjars/sockjs-client/sockjs.min.js"></script>
        <script src="/webjars/stomp-websocket/stomp.min.js"></script>
        <script src="/webjars/jquery/jquery.min.js"></script>
        <script>
                   //Web Sockets
        var socket = new SockJS('/gs-guide-websocket');
        stompClient = Stomp.over(socket);
        stompClient.connect({}, function (frame) {
        console.log('Connected: ' + frame);

        var userName = "nyla";

        stompClient.subscribe('/topic/customerPromotions/'+userName, function (promotionResponse) {

                var promotion = JSON.parse(promotionResponse.body);
                addPromotion(promotion);
            });
    });

    function urlify(text) {
        var urlRegex = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlRegex, function(url) {
        return '<a href="' + url + '">' + url + '</a>';
        })
    }

    function addPromotion(promotion)
    {

        var tableContent = document.getElementById("promotions");
        var newMessage= promotion.marketingMessage;

        if(tableContent.innerHTML.indexOf(newMessage) > -1)
        	return false;

        $('#promotions').prepend(promotionDisplay(newMessage));
    }

    function promotionDisplay(message) {
        return "<a href = '" + urlify(message) + "'>" +
                    "<div class = 'promotion'>" +
                        "<div><h3>" + message + "</h3></div>" +
                        "<div class = 'promotion-action'>Try Now" +
                            "<i class='material-icons'>chevron_right</i>" +
                        "</div>" +
                    "</div>"
                "</a>";
    }
        </script>
    </head>

    <body>
        <ul>
            <li><a href="/swagger-ui.html">Swagger-UI</a></li>
            <li><a href="/api-docs">Api-docs</a></li>
        </ul>
        <hr/>

        <div class = "promotions-header"><h2>Promotions</h2></div>
        <div class = "promotions-container" id = "promotions">

        </div>


        <hr/>
        <table id="customerFavorites">

        </table>

    </body>
<script>

    $(document).ready(
    function() {
        var sse = new EventSource('customer/favorites/favorite/nyla');

        sse.onmessage = function(message) {

        console.log("data: "+message.data);
       	var customerFavorites= JSON.parse(message.data);
       	var tableContent = document.getElementById("customerFavorites");

        var productQuantity;
        for (let x in customerFavorites.favorites) {
           productQuantity = customerFavorites.favorites[x];

            if(tableContent.innerHTML.indexOf(productQuantity.product.name) > -1)
        	    continue; //already exist

            $('#customerFavorites').prepend('<tr> ' +
                '<td><div">'+ productQuantity.product.name + '</div></td>' +
                '<td">&nbsp;</td> </tr>');
        }


       }
   }
);
</script>
</html>